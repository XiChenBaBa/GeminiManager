<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini API ä»£ç†ç®¡ç†</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="navbar">
            <h1>ğŸ¤– Gemini API ä»£ç†ç®¡ç†</h1>
            <div class="navbar-actions">
                <span class="admin-info">ğŸ‘¤ ç®¡ç†å‘˜å·²ç™»å½•</span>
                <a href="{{ url_for('logout') }}" class="logout-btn">ğŸšª ç™»å‡º</a>
            </div>
        </div>
        
        <!-- æ¶ˆæ¯æç¤º -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        
        <!-- æœåŠ¡çŠ¶æ€ -->
        <div class="section">
            <h2>ğŸ“Š æœåŠ¡çŠ¶æ€</h2>
            <div class="status-grid">
                <div class="status-item">
                    <span class="status-label">æ€»APIå¯†é’¥æ•°ï¼š</span>
                    <span class="status-value">{{ config.api_keys|length }}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">å¯ç”¨å¯†é’¥æ•°ï¼š</span>
                    <span class="status-value available">{{ (config.api_keys|length) - (config.disabled_keys|length) }}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">ç¦ç”¨å¯†é’¥æ•°ï¼š</span>
                    <span class="status-value disabled">{{ config.disabled_keys|length }}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">ä»£ç†æ•°é‡ï¼š</span>
                    <span class="status-value">{{ config.proxies|length }}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">æ€»è°ƒç”¨æ¬¡æ•°ï¼š</span>
                    <span class="status-value" id="total-calls">è®¡ç®—ä¸­...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">æˆåŠŸç‡ï¼š</span>
                    <span class="status-value" id="success-rate">è®¡ç®—ä¸­...</span>
                </div>
            </div>
        </div>
        
        <!-- å®‰å…¨è®¾ç½® -->
        <div class="section">
            <h2>ğŸ” å®‰å…¨è®¾ç½®</h2>
            
            <!-- è®¿é—®å¯†é’¥è®¾ç½® -->
            <div class="security-item">
                <h3>APIè®¿é—®å¯†é’¥</h3>
                <form method="POST" action="{{ url_for('set_access_key') }}">
                    <div class="form-group">
                        <input type="text" name="access_key" placeholder="è¾“å…¥æ–°çš„è®¿é—®å¯†é’¥" 
                               value="{{ config.access_key }}" required>
                        <button type="submit">æ›´æ–°è®¿é—®å¯†é’¥</button>
                    </div>
                </form>
            </div>
            
            <!-- ç®¡ç†å‘˜å¯†ç è®¾ç½® -->
            <div class="security-item">
                <h3>ç®¡ç†å‘˜å¯†ç </h3>
                <form method="POST" action="{{ url_for('set_admin_password') }}">
                    <div class="form-group">
                        <input type="password" name="new_password" placeholder="è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" required>
                        <input type="password" name="confirm_password" placeholder="ç¡®è®¤æ–°å¯†ç " required>
                        <button type="submit">æ›´æ–°å¯†ç </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- APIå¯†é’¥ç®¡ç† -->
        <div class="section">
            <h2>ğŸ” APIå¯†é’¥ç®¡ç†</h2>
            
            <!-- æ·»åŠ APIå¯†é’¥ -->
            <form method="POST" action="{{ url_for('add_api_key') }}">
                <div class="form-group">
                    <input type="text" name="api_key" placeholder="è¾“å…¥Gemini APIå¯†é’¥" required>
                    <button type="submit">æ·»åŠ APIå¯†é’¥</button>
                </div>
            </form>
            
            <!-- APIå¯†é’¥åˆ—è¡¨ -->
            <div class="key-list">
                <h3>å½“å‰APIå¯†é’¥åˆ—è¡¨</h3>
                {% if config.api_keys %}
                    {% for key in config.api_keys %}
                        {% set stats = config.api_key_stats.get(key, {'call_count': 0, 'success_count': 0, 'error_count': 0, 'last_used': None}) %}
                        <div class="key-item {% if key in config.disabled_keys %}disabled{% endif %}">
                            <div class="key-info">
                                <span class="key-text" 
                                      title="å®Œæ•´å¯†é’¥: {{ key }}"
                                      data-full-key="{{ key }}">{{ key[:20] }}...</span>
                                <div class="key-status-row">
                                    <span class="key-status">
                                        {% if key in config.disabled_keys %}
                                            <span class="status-disabled">âŒ å·²ç¦ç”¨ (APIå¯†é’¥æ— æ•ˆ)</span>
                                        {% else %}
                                            <span class="status-active">âœ… å¯ç”¨</span>
                                        {% endif %}
                                    </span>
                                    <span class="call-stats">
                                        ğŸ“ è°ƒç”¨: <strong>{{ stats.call_count }}</strong> æ¬¡
                                        {% if stats.call_count > 0 %}
                                            (æˆåŠŸ: <span class="success-count">{{ stats.success_count }}</span>, 
                                             å¤±è´¥: <span class="error-count">{{ stats.error_count }}</span>,
                                             æˆåŠŸç‡: <span class="success-rate">{{ "%.1f"|format((stats.success_count / stats.call_count * 100) if stats.call_count > 0 else 0) }}%</span>)
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="key-details">
                                    {% if key in config.key_proxy_mapping %}
                                        <span class="proxy-info">ğŸ”— ä»£ç†: {{ config.key_proxy_mapping[key] }}</span>
                                    {% else %}
                                        <span class="proxy-info">ğŸŒ ç›´è¿</span>
                                    {% endif %}
                                    {% if stats.last_used %}
                                        <span class="last-used">ğŸ•’ æœ€åä½¿ç”¨: {{ stats.last_used[:19].replace('T', ' ') }}</span>
                                    {% else %}
                                        <span class="last-used">ğŸ•’ ä»æœªä½¿ç”¨</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="key-actions">
                                <!-- æµ‹è¯•æŒ‰é’® -->
                                <form method="POST" action="{{ url_for('test_api_key') }}" style="display:inline;">
                                    <input type="hidden" name="api_key" value="{{ key }}">
                                    <button type="submit" class="btn-test" title="æµ‹è¯•APIå¯†é’¥">ğŸ§ª æµ‹è¯•</button>
                                </form>
                                
                                <!-- é‡ç½®ç»Ÿè®¡æŒ‰é’® -->
                                <form method="POST" action="{{ url_for('reset_stats') }}" style="display:inline;">
                                    <input type="hidden" name="api_key" value="{{ key }}">
                                    <button type="submit" class="btn-info" title="é‡ç½®ç»Ÿè®¡ä¿¡æ¯"
                                            onclick="return confirm('ç¡®å®šè¦é‡ç½®è¿™ä¸ªAPIå¯†é’¥çš„ç»Ÿè®¡ä¿¡æ¯å—ï¼Ÿ')">ğŸ“Š é‡ç½®</button>
                                </form>
                                
                                <!-- åˆ é™¤æŒ‰é’® -->
                                <form method="POST" action="{{ url_for('remove_api_key') }}" style="display:inline;">
                                    <input type="hidden" name="api_key" value="{{ key }}">
                                    <button type="submit" class="btn-danger" title="åˆ é™¤APIå¯†é’¥"
                                            onclick="return confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªAPIå¯†é’¥å—ï¼Ÿ')">ğŸ—‘ï¸ åˆ é™¤</button>
                                </form>
                                
                                <!-- å¯ç”¨/ç¦ç”¨æŒ‰é’® -->
                                <form method="POST" action="{{ url_for('toggle_key') }}" style="display:inline;">
                                    <input type="hidden" name="api_key" value="{{ key }}">
                                    {% if key in config.disabled_keys %}
                                        <input type="hidden" name="action" value="enable">
                                        <button type="submit" class="btn-success" title="é‡æ–°å¯ç”¨APIå¯†é’¥">âœ… å¯ç”¨</button>
                                    {% else %}
                                        <input type="hidden" name="action" value="disable">
                                        <button type="submit" class="btn-warning" title="æ‰‹åŠ¨ç¦ç”¨APIå¯†é’¥">â›” ç¦ç”¨</button>
                                    {% endif %}
                                </form>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="no-data">æš‚æ— APIå¯†é’¥</p>
                {% endif %}
            </div>
        </div>
        
        <!-- ä»£ç†ç®¡ç† -->
        <div class="section">
            <h2>ğŸŒ ä»£ç†ç®¡ç†</h2>
            
            <!-- æ·»åŠ ä»£ç† -->
            <form method="POST" action="{{ url_for('add_proxy') }}">
                <div class="form-group">
                    <input type="text" name="proxy_url" placeholder="è¾“å…¥SOCKS5ä»£ç† (ä¾‹å¦‚: socks5://127.0.0.1:1080)" required>
                    <button type="submit">æ·»åŠ ä»£ç†</button>
                </div>
            </form>
            
            <!-- ä»£ç†åˆ—è¡¨ -->
            <div class="proxy-list">
                <h3>å½“å‰ä»£ç†åˆ—è¡¨</h3>
                {% if config.proxies %}
                    {% for proxy in config.proxies %}
                        <div class="proxy-item">
                            <span class="proxy-url">{{ proxy }}</span>
                            <form method="POST" action="{{ url_for('remove_proxy') }}" style="display:inline;">
                                <input type="hidden" name="proxy_url" value="{{ proxy }}">
                                <button type="submit" class="btn-danger" 
                                        onclick="return confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»£ç†å—ï¼Ÿ')">åˆ é™¤</button>
                            </form>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="no-data">æš‚æ— ä»£ç†é…ç½®</p>
                {% endif %}
            </div>
        </div>
        
        <!-- ä»£ç†æ˜ å°„ -->
        <div class="section">
            <h2>ğŸ”— APIå¯†é’¥ä»£ç†æ˜ å°„</h2>
            {% if config.api_keys %}
                <form method="POST" action="{{ url_for('set_key_proxy') }}">
                    <div class="form-group">
                        <select name="api_key" required>
                            <option value="">é€‰æ‹©APIå¯†é’¥</option>
                            {% for key in config.api_keys %}
                                <option value="{{ key }}" title="{{ key }}">{{ key[:20] }}...</option>
                            {% endfor %}
                        </select>
                        
                        <select name="proxy_url">
                            <option value="">ä¸ä½¿ç”¨ä»£ç†</option>
                            {% for proxy in config.proxies %}
                                <option value="{{ proxy }}">{{ proxy }}</option>
                            {% endfor %}
                        </select>
                        
                        <button type="submit">è®¾ç½®æ˜ å°„</button>
                    </div>
                </form>
                
                <!-- å½“å‰æ˜ å°„å…³ç³» -->
                {% if config.key_proxy_mapping %}
                    <div class="mapping-list">
                        <h4>å½“å‰æ˜ å°„å…³ç³»ï¼š</h4>
                        {% for key, proxy in config.key_proxy_mapping.items() %}
                            <div class="mapping-item">
                                <span class="mapping-key" title="{{ key }}">{{ key[:20] }}...</span>
                                <span class="mapping-arrow">â†’</span>
                                <span class="mapping-proxy">{{ proxy }}</span>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% else %}
                <p class="no-data">è¯·å…ˆæ·»åŠ APIå¯†é’¥</p>
            {% endif %}
        </div>
        
        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="section">
            <h2>ğŸ“– ä½¿ç”¨è¯´æ˜</h2>
            <div class="usage-info">
                <h3>APIè°ƒç”¨æ–¹å¼ï¼š</h3>
                <pre><code>curl "http://127.0.0.1/v1/chat/completions" \
-H "Content-Type: application/json" \
-H "Authorization: Bearer {{ config.access_key }}" \
-d "{\"model\": \"gemini-2.5-flash-preview-05-20\", \"reasoning_effort\": \"low\", \"messages\": [{\"role\": \"user\", \"content\": \"Explain to me how AI works\"}]}"</code></pre>
                
                <h3>PowerShellè°ƒç”¨æ–¹å¼ï¼š</h3>
                <pre><code>$headers = @{
    "Content-Type" = "application/json"
    "Authorization" = "Bearer {{ config.access_key }}"
}

$body = @{
    model = "gemini-2.5-flash-preview-05-20"
    reasoning_effort = "low"
    messages = @(
        @{
            role = "user"
            content = "Explain to me how AI works"
        }
    )
} | ConvertTo-Json -Depth 3

Invoke-RestMethod -Uri "http://127.0.0.1/v1/chat/completions" -Method POST -Headers $headers -Body $body</code></pre>
                
                <h3>æœåŠ¡çŠ¶æ€æŸ¥è¯¢ï¼š</h3>
                <p>è®¿é—® <code>http://127.0.0.1/status</code> æŸ¥çœ‹æœåŠ¡çŠ¶æ€</p>
                
                <h3>åŠŸèƒ½è¯´æ˜ï¼š</h3>
                <ul>
                    <li>ğŸ”„ <strong>è‡ªåŠ¨è½®è¯¢ï¼š</strong> ç³»ç»Ÿä¼šè‡ªåŠ¨è½®è¯¢ä½¿ç”¨å¯ç”¨çš„APIå¯†é’¥</li>
                    <li>ğŸ›¡ï¸ <strong>è‡ªåŠ¨ç¦ç”¨ï¼š</strong> æ— æ•ˆçš„APIå¯†é’¥ä¼šè¢«è‡ªåŠ¨æ£€æµ‹å¹¶ç¦ç”¨</li>
                    <li>ğŸŒ <strong>ä»£ç†æ”¯æŒï¼š</strong> æ”¯æŒä¸ºæ¯ä¸ªAPIå¯†é’¥é…ç½®ç‹¬ç«‹çš„SOCKS5ä»£ç†</li>
                    <li>ğŸ”§ <strong>å®æ—¶ç®¡ç†ï¼š</strong> æ‰€æœ‰é…ç½®æ›´æ”¹ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯æœåŠ¡</li>
                    <li>ğŸ“Š <strong>ç»Ÿè®¡ç›‘æ§ï¼š</strong> å®æ—¶æŸ¥çœ‹æ¯ä¸ªAPIå¯†é’¥çš„è°ƒç”¨ç»Ÿè®¡å’ŒæˆåŠŸç‡</li>
                    <li>ğŸ” <strong>å®Œæ•´æ˜¾ç¤ºï¼š</strong> é¼ æ ‡æ‚¬åœåœ¨APIå¯†é’¥ä¸Šå¯æŸ¥çœ‹å®Œæ•´å¯†é’¥</li>
                    <li>ğŸ” <strong>å®‰å…¨è®¤è¯ï¼š</strong> ç®¡ç†é¢æ¿éœ€è¦å¯†ç è®¤è¯ï¼Œä¼šè¯æœ‰æ•ˆæœŸ1å°æ—¶</li>
                </ul>
            </div>
        </div>
        
        <!-- æ—¥å¿—å’Œè°ƒè¯• -->
        <div class="section">
            <h2>ğŸ” è°ƒè¯•ä¿¡æ¯</h2>
            <div class="debug-info">
                <p><strong>é…ç½®æ–‡ä»¶ï¼š</strong> config.json</p>
                <p><strong>æ—¥å¿—çº§åˆ«ï¼š</strong> INFO</p>
                <p><strong>SOCKSæ”¯æŒï¼š</strong> 
                    <span id="socks-status">æ£€æŸ¥ä¸­...</span>
                </p>
                <p><strong>ä¼šè¯çŠ¶æ€ï¼š</strong> 
                    <span class="session-active">âœ… å·²è®¤è¯</span>
                </p>
                <button onclick="checkStatus()" class="btn-info">åˆ·æ–°çŠ¶æ€</button>
            </div>
        </div>
    </div>

    <!-- æ‚¬æµ®æç¤ºæ¡† -->
    <div id="key-tooltip" class="key-tooltip"></div>

    <script>
        // æ£€æŸ¥æœåŠ¡çŠ¶æ€
        function checkStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('socks-status').textContent = 
                        data.socks_support ? 'âœ… å·²å¯ç”¨' : 'âŒ æœªå¯ç”¨';
                    
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    const totalCallsElement = document.getElementById('total-calls');
                    const successRateElement = document.getElementById('success-rate');
                    
                    if (totalCallsElement) {
                        totalCallsElement.textContent = data.total_calls;
                    }
                    if (successRateElement) {
                        successRateElement.textContent = data.success_rate + '%';
                    }
                    
                    // æ›´æ–°å…¶ä»–çŠ¶æ€é¡¹
                    const statusItems = document.querySelectorAll('.status-value');
                    if (statusItems.length >= 4) {
                        statusItems[0].textContent = data.total_keys;
                        statusItems[1].textContent = data.available_keys;
                        statusItems[2].textContent = data.disabled_keys;
                        statusItems[3].textContent = data.proxies;
                    }
                })
                .catch(error => {
                    console.error('è·å–çŠ¶æ€å¤±è´¥:', error);
                    document.getElementById('socks-status').textContent = 'âŒ æ£€æŸ¥å¤±è´¥';
                });
        }
        
        // APIå¯†é’¥æ‚¬æµ®æ˜¾ç¤ºåŠŸèƒ½
        function initKeyTooltip() {
            const tooltip = document.getElementById('key-tooltip');
            const keyTexts = document.querySelectorAll('.key-text[data-full-key]');
            
            keyTexts.forEach(keyText => {
                keyText.addEventListener('mouseenter', function(e) {
                    const fullKey = this.getAttribute('data-full-key');
                    tooltip.textContent = fullKey;
                    tooltip.style.display = 'block';
                    tooltip.style.opacity = '1';
                });
                
                keyText.addEventListener('mousemove', function(e) {
                    tooltip.style.left = (e.pageX + 10) + 'px';
                    tooltip.style.top = (e.pageY - 30) + 'px';
                });
                
                keyText.addEventListener('mouseleave', function() {
                    tooltip.style.opacity = '0';
                    setTimeout(() => {
                        tooltip.style.display = 'none';
                    }, 200);
                });
            });
        }
        
        // å¤åˆ¶APIå¯†é’¥åŠŸèƒ½
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                const toast = document.createElement('div');
                toast.className = 'copy-toast';
                toast.textContent = 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿';
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 2000);
            }).catch(function(err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
            });
        }
        
        // ä¸ºAPIå¯†é’¥æ·»åŠ ç‚¹å‡»å¤åˆ¶åŠŸèƒ½
        function initCopyFeature() {
            const keyTexts = document.querySelectorAll('.key-text[data-full-key]');
            
            keyTexts.forEach(keyText => {
                keyText.style.cursor = 'pointer';
                keyText.addEventListener('click', function() {
                    const fullKey = this.getAttribute('data-full-key');
                    copyToClipboard(fullKey);
                });
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkStatus();
            initKeyTooltip();
            initCopyFeature();
            
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
            setInterval(checkStatus, 30000);
        });
        
        // è‡ªåŠ¨éšè—æ¶ˆæ¯æç¤º
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                setTimeout(() => {
                    alert.style.opacity = '0';
                    setTimeout(() => {
                        alert.remove();
                    }, 300);
                }, 5000);
            });
        });
    </script>
</body>
</html>
